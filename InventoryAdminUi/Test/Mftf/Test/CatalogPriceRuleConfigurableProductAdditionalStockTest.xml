<?xml version="1.0" encoding="UTF-8"?>
<!--
 /**
  * Copyright Â© Magento, Inc. All rights reserved.
  * See COPYING.txt for license details.
  */
-->

<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="urn:magento:mftf:Test/etc/testSchema.xsd">
    <test name="CatalogPriceRuleConfigurableProductAdditionalStockTest" extends="AdminCreateCatalogPriceRuleForCustomerGroupTest">
        <annotations>
            <stories value="Configurable Product Additional Stock."/>
            <title value="Catalog price rule with configurable product and additional stock."/>
            <description value="Verify catalog price rule applied correctly for configurable product on additional stock."/>
            <testCaseId value="https://app.hiptest.com/projects/69435/test-plan/folders/444060/scenarios/1523632"/>
            <severity value="CRITICAL"/>
            <group value="msi"/>
            <group value="multi_mode"/>
        </annotations>

        <before>
            <!--Create additional source and stock.-->
            <createData entity="_minimalSource" stepKey="source" after="createProduct"/>
            <createData entity="BasicMsiStockWithMainWebsite1" stepKey="stock" after="source"/>
            <!--Link additional source with stock.-->
            <createData entity="SourceStockLinked1" stepKey="stockSourceLink" after="stock">
                <requiredEntity createDataKey="stock"/>
                <requiredEntity createDataKey="source"/>
            </createData>
            <!--Replace simple product with configurable.-->
            <remove keyForRemoval="createProduct"/>
            <createData entity="ApiConfigurableProduct" stepKey="createProduct">
                <requiredEntity createDataKey="createCategory"/>
            </createData>
            <createData entity="productAttributeWithTwoOptions" stepKey="configurableProductAttribute" after="createProduct"/>
            <createData entity="productAttributeOption1" stepKey="configurableProductAttributeOption" after="configurableProductAttribute">
                <requiredEntity createDataKey="configurableProductAttribute"/>
            </createData>
            <createData entity="AddToDefaultSet" stepKey="createConfigAddToAttributeSet" after="configurableProductAttributeOption">
                <requiredEntity createDataKey="configurableProductAttribute"/>
            </createData>
            <getData entity="ProductAttributeOptionGetter" index="1" stepKey="getConfigAttributeOption" after="createConfigAddToAttributeSet">
                <requiredEntity createDataKey="configurableProductAttribute"/>
            </getData>
            <createData entity="ApiSimpleOne" stepKey="configurableChildProduct" after="getConfigAttributeOption">
                <requiredEntity createDataKey="configurableProductAttribute"/>
                <requiredEntity createDataKey="getConfigAttributeOption"/>
            </createData>
            <createData entity="ConfigurableProductOneOption" stepKey="configurableProductOption" after="configurableChildProduct">
                <requiredEntity createDataKey="createProduct"/>
                <requiredEntity createDataKey="configurableProductAttribute"/>
                <requiredEntity createDataKey="getConfigAttributeOption"/>
            </createData>
            <createData entity="ConfigurableProductAddChild" stepKey="configurableProductAddChild" after="configurableProductOption">
                <requiredEntity createDataKey="createProduct"/>
                <requiredEntity createDataKey="configurableChildProduct"/>
            </createData>
            <!--Assign additional source to configurable product.-->
            <amOnPage url="{{AdminProductEditPage.url($configurableChildProduct.id$)}}" stepKey="openProductEditPage" after="loginAsAdmin"/>
            <actionGroup ref="UnassignSourceFromProductActionGroup" stepKey="unassignDefaultSourceFromProduct" after="openProductEditPage">
                <argument name="sourceCode" value="{{_defaultSource.name}}"/>
            </actionGroup>
            <actionGroup ref="AdminAssignSourceToProductAndSetSourceQuantityActionGroup" stepKey="assignSourceToProduct" after="unassignDefaultSourceFromProduct">
                <argument name="sourceCode" value="$source.source[source_code]$"/>
            </actionGroup>
            <actionGroup ref="SaveProductFormActionGroup" stepKey="saveProduct" after="assignSourceToProduct"/>
        </before>
        <after>
            <!--Clean up test data.-->
            <deleteData createDataKey="configurableChildProduct" stepKey="deleteConfigurableProductVariation" after="deleteCategory"/>
            <deleteData createDataKey="configurableProductAttribute" stepKey="deleteConfigurableProductAttribute" after="deleteConfigurableProductVariation"/>
            <!--Assign Default Stock to Default Website.-->
            <actionGroup ref="AssignWebsiteToStockActionGroup" stepKey="assignMainWebsiteToDefaultStock" after="deleteConfigurableProductAttribute">
                <argument name="stockName" value="{{_defaultStock.name}}"/>
                <argument name="websiteName" value="{{_defaultWebsite.name}}"/>
            </actionGroup>
            <!--Disable additional source.-->
            <actionGroup ref="DisableAllSourcesActionGroup" stepKey="disableCreatedSource" before="assignMainWebsiteToDefaultStock"/>
            <!--Delete stock.-->
            <deleteData createDataKey="stock" stepKey="deleteStock" after="assignMainWebsiteToDefaultStock"/>
        </after>

        <!--Verify configurable product prices.-->
        <remove keyForRemoval="seeDiscountedPrice1"/>
        <see selector="{{StorefrontCategoryProductSection.ProductInfoByNumber('1')}}" userInput="As low as $110.70" stepKey="seeDiscountedPrice1" after="seeProduct1"/>
        <remove keyForRemoval="seeDiscountedPrice2"/>
        <see selector="{{StorefrontCategoryProductSection.ProductInfoByNumber('1')}}" userInput="As low as ${{ApiSimpleOne.price}}" stepKey="seeDiscountedPrice2" after="seeProduct2"/>
    </test>
</tests>
